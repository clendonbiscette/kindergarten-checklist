generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String           @id @default(uuid())
  email                String           @unique
  passwordHash         String           @map("password_hash")
  firstName            String           @map("first_name")
  lastName             String           @map("last_name")
  role                 UserRole
  isActive             Boolean          @default(true) @map("is_active")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")
  assessmentsCreated   Assessment[]     @relation("CreatedAssessments")
  assessmentsAsTeacher Assessment[]     @relation("TeacherAssessments")
  assessmentsUpdated   Assessment[]     @relation("UpdatedAssessments")
  classes              Class[]
  studentParents       StudentParent[]
  assignments          UserAssignment[]

  @@index([role])
  @@index([isActive])
  @@map("users")
}

model Country {
  id          String           @id @default(uuid())
  name        String
  code        String           @unique
  createdAt   DateTime         @default(now()) @map("created_at")
  schools     School[]
  assignments UserAssignment[]

  @@map("countries")
}

model School {
  id          String           @id @default(uuid())
  name        String
  countryId   String           @map("country_id")
  address     String?
  phone       String?
  email       String?
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  terms       AcademicTerm[]
  classes     Class[]
  country     Country          @relation(fields: [countryId], references: [id])
  students    Student[]
  assignments UserAssignment[]

  @@index([countryId])
  @@map("schools")
}

model Class {
  id           String    @id @default(uuid())
  name         String
  gradeLevel   String    @map("grade_level")
  schoolId     String    @map("school_id")
  teacherId    String?   @map("teacher_id")
  academicYear String    @map("academic_year")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  school       School    @relation(fields: [schoolId], references: [id])
  teacher      User?     @relation(fields: [teacherId], references: [id])
  students     Student[]

  @@index([schoolId])
  @@index([teacherId])
  @@index([academicYear])
  @@map("classes")
}

model UserAssignment {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  schoolId  String?  @map("school_id")
  countryId String?  @map("country_id")
  createdAt DateTime @default(now()) @map("created_at")
  country   Country? @relation(fields: [countryId], references: [id], onDelete: Cascade)
  school    School?  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([schoolId])
  @@index([countryId])
  @@map("user_assignments")
}

model Student {
  id              String          @id @default(uuid())
  firstName       String          @map("first_name")
  lastName        String          @map("last_name")
  dateOfBirth     DateTime?       @map("date_of_birth")
  studentIdNumber String          @map("student_id_number")
  schoolId        String          @map("school_id")
  classId         String?         @map("class_id")
  enrollmentDate  DateTime        @default(now()) @map("enrollment_date")
  isActive        Boolean         @default(true) @map("is_active")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  assessments     Assessment[]
  studentParents  StudentParent[]
  class           Class?          @relation(fields: [classId], references: [id])
  school          School          @relation(fields: [schoolId], references: [id])

  @@unique([schoolId, studentIdNumber])
  @@index([schoolId])
  @@index([classId])
  @@index([isActive])
  @@index([lastName, firstName])
  @@map("students")
}

model StudentParent {
  id           String   @id @default(uuid())
  studentId    String   @map("student_id")
  userId       String   @map("user_id")
  relationship String
  createdAt    DateTime @default(now()) @map("created_at")
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([userId])
  @@map("student_parents")
}

model Subject {
  id               String            @id @default(uuid())
  name             String            @unique
  displayOrder     Int               @map("display_order")
  createdAt        DateTime          @default(now()) @map("created_at")
  learningOutcomes LearningOutcome[]
  strands          Strand[]

  @@map("subjects")
}

model Strand {
  id               String            @id @default(uuid())
  subjectId        String            @map("subject_id")
  name             String
  displayOrder     Int               @map("display_order")
  createdAt        DateTime          @default(now()) @map("created_at")
  learningOutcomes LearningOutcome[]
  subject          Subject           @relation(fields: [subjectId], references: [id])

  @@unique([subjectId, name], name: "subjectId_name")
  @@index([subjectId])
  @@map("strands")
}

model LearningOutcome {
  id           String       @id @default(uuid())
  subjectId    String       @map("subject_id")
  strandId     String       @map("strand_id")
  code         String
  description  String
  displayOrder Int          @map("display_order")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  assessments  Assessment[]
  strand       Strand       @relation(fields: [strandId], references: [id])
  subject      Subject      @relation(fields: [subjectId], references: [id])

  @@unique([subjectId, code])
  @@index([subjectId])
  @@index([strandId])
  @@map("learning_outcomes")
}

model AcademicTerm {
  id          String       @id @default(uuid())
  name        String
  schoolYear  String       @map("school_year")
  startDate   DateTime     @map("start_date")
  endDate     DateTime     @map("end_date")
  schoolId    String       @map("school_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  school      School       @relation(fields: [schoolId], references: [id])
  assessments Assessment[]

  @@index([schoolId])
  @@index([schoolYear])
  @@map("academic_terms")
}

model Assessment {
  id                String           @id @default(uuid())
  studentId         String           @map("student_id")
  learningOutcomeId String           @map("learning_outcome_id")
  teacherId         String           @map("teacher_id")
  termId            String           @map("term_id")
  assessmentDate    DateTime         @map("assessment_date")
  rating            AssessmentRating
  comment           String?
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  createdBy         String           @map("created_by")
  updatedBy         String?          @map("updated_by")
  creator           User             @relation("CreatedAssessments", fields: [createdBy], references: [id])
  learningOutcome   LearningOutcome  @relation(fields: [learningOutcomeId], references: [id])
  student           Student          @relation(fields: [studentId], references: [id])
  teacher           User             @relation("TeacherAssessments", fields: [teacherId], references: [id])
  term              AcademicTerm     @relation(fields: [termId], references: [id])
  updater           User?            @relation("UpdatedAssessments", fields: [updatedBy], references: [id])

  @@index([studentId, learningOutcomeId, assessmentDate])
  @@index([teacherId, termId])
  @@map("assessments")
}

enum UserRole {
  TEACHER
  SCHOOL_ADMIN
  COUNTRY_ADMIN
  PARENT_STUDENT
  SUPERUSER
}

enum AssessmentRating {
  EASILY_MEETING
  MEETING
  NEEDS_PRACTICE
}
